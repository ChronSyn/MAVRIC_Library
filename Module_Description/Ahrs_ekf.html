<!DOCTYPE html>
<!--[if lt IE 7]>       <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>          <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>          <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->  <html class="no-js" lang="en"> <!--<![endif]-->
<head>
    <title>Ahrs ekf - MAV'RIC Library</title>
    <meta name="description" content="Highway to the Danger Zone" />
    <meta name="author" content="MAV'RIC Team">
    <meta charset="UTF-8">
    <link rel="icon" href="../themes/daux/img/favicon-navy.png" type="image/x-icon">
    <!-- Mobile -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Font -->
    <link href='//fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700&subset=latin,cyrillic-ext,cyrillic' rel='stylesheet' type='text/css'>
    <!-- CSS -->
    <link href='../themes/daux/css/theme.min.css' rel='stylesheet' type='text/css'><link href='../themes/daux/css/theme-navy.min.css' rel='stylesheet' type='text/css'>
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body class="">
    
    <a href="https://github.com/lis-epfl/MAVRIC_Library" target="_blank" id="github-ribbon" class="hidden-print"><img src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>
<div class="container-fluid fluid-height wrapper">
    <div class="navbar navbar-static-top hidden-print">
        <div class="container-fluid">
            <a class="brand navbar-brand pull-left" href="../index.html">MAV'RIC Library</a>
        </div>
    </div>
    <div class="row columns content">
        <div class="left-column article-tree col-sm-3 hidden-print">
            <!-- For Mobile -->
            <div class="responsive-collapse">
                <button type="button" class="btn btn-sidebar" id="menu-spinner-button">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div id="sub-nav-collapse" class="sub-nav-collapse">
                <!-- Navigation -->
                <ul class='nav nav-list'><li class=''><a href="../Getting_Started.html">Getting Started</a></li><li class=''><a href="../User_Guide/index.html" class="folder">User Guide</a><ul class='nav nav-list'></ul></li><li class=''><a href="../Toolchain/index.html" class="folder">Toolchain</a><ul class='nav nav-list'><li class=''><a href="../Toolchain/AVR32_compiler.html">AVR32 compiler</a></li><li class=''><a href="../Toolchain/AVR32_Bootloader.html">AVR32 Bootloader</a></li><li class=''><a href="../Toolchain/AVR32_DFU_Programming.html">AVR32 DFU Programming</a></li><li class=''><a href="../Toolchain/STM32.html">STM32</a></li><li class=''><a href="../Toolchain/Emulation.html">Emulation</a></li><li class=''><a href="../Toolchain/Test_Toolchains.html">Test Toolchains</a></li></ul></li><li class=''><a href="../Developper_Guide/index.html" class="folder">Developper Guide</a><ul class='nav nav-list'><li class=''><a href="../Developper_Guide/Create_New_Telemetry_Messages.html">Create New Telemetry Messages</a></li><li class=''><a href="../Developper_Guide/Data_Logging.html">Data Logging</a></li><li class=''><a href="../Developper_Guide/Code_style.html">Code style</a></li></ul></li><li class=''><a href="#" class="aj-nav folder">Contributing</a><ul class='nav nav-list'><li class=''><a href="../Contributing/Contribute_to_the_Documentation.html">Contribute to the Documentation</a></li><li class=''><a href="../Contributing/Development_Workflow.html">Development Workflow</a></li></ul></li><li class='open'><a href="#" class="aj-nav folder">Module Description</a><ul class='nav nav-list'><li class='active'><a href="../Module_Description/Ahrs_ekf.html">Ahrs ekf</a></li></ul></li><li class=''><a href="#" class="aj-nav folder">Pages From Wiki</a><ul class='nav nav-list'><li class=''><a href="../Pages_From_Wiki/Calibration-Bias-Factors.html">Calibration-Bias-Factors</a></li><li class=''><a href="../Pages_From_Wiki/Calibration-Scale-Factors.html">Calibration-Scale-Factors</a></li><li class=''><a href="../Pages_From_Wiki/Connect-a-Joystick-to-QGroundControl.html">Connect-a-Joystick-to-QGroundControl</a></li><li class=''><a href="../Pages_From_Wiki/Debug-via-minicom-software-on-Linux.html">Debug-via-minicom-software-on-Linux</a></li><li class=''><a href="../Pages_From_Wiki/Download-Firmware.html">Download-Firmware</a></li><li class=''><a href="../Pages_From_Wiki/Download-Git-Tools.html">Download-Git-Tools</a></li><li class=''><a href="../Pages_From_Wiki/Download-IDE.html">Download-IDE</a></li><li class=''><a href="../Pages_From_Wiki/Download-QGroundcontrol.html">Download-QGroundcontrol</a></li><li class=''><a href="../Pages_From_Wiki/Electronic-board.html">Electronic-board</a></li><li class=''><a href="../Pages_From_Wiki/FAQ.html">FAQ</a></li><li class=''><a href="../Pages_From_Wiki/First-Steps-Binding-your-Remote.html">First-Steps-Binding-your-Remote</a></li><li class=''><a href="../Pages_From_Wiki/First-steps-CDC-and-DFU-Drivers-issue-on-Windows.html">First-steps-CDC-and-DFU-Drivers-issue-on-Windows</a></li><li class=''><a href="../Pages_From_Wiki/First-steps-Connect-to-QGroundControl.html">First-steps-Connect-to-QGroundControl</a></li><li class=''><a href="../Pages_From_Wiki/First-steps-pairing-XBee-modules.html">First-steps-pairing-XBee-modules</a></li><li class=''><a href="../Pages_From_Wiki/Flashing-a-microcontroller-for-the-first-time.html">Flashing-a-microcontroller-for-the-first-time</a></li><li class=''><a href="../Pages_From_Wiki/Home.html">Home</a></li><li class=''><a href="../Pages_From_Wiki/Quad-Assembly-Building-Steps.html">Quad-Assembly-Building-Steps</a></li><li class=''><a href="../Pages_From_Wiki/Quad-Assembly-Part-List.html">Quad-Assembly-Part-List</a></li><li class=''><a href="../Pages_From_Wiki/Quad-Assembly-Remote-Pairing.html">Quad-Assembly-Remote-Pairing</a></li><li class=''><a href="../Pages_From_Wiki/Remote-settings.html">Remote-settings</a></li></ul></li></ul>

                <div class="sidebar-links">
                    
                        <!-- Links -->
                        <a href="https://github.com/lis-epfl/MAVRIC_Library/archive/master.zip" target="_blank">Download</a><br><a href="https://github.com/lis-epfl/MAVRIC_Library" target="_blank">GitHub Repo</a><br><a href="https://github.com/lis-epfl/MAVRIC_Library/issues" target="_blank">Help/Support/Bugs</a><br><a href="http://lis-epfl.github.io/MAVRIC_Library/doxygen/classes.html" target="_blank">Doxygen Documentation</a><br>
                        <!-- Twitter -->
                        
                        <hr/>
                    
                    <p><small>Documentation generated by <a href="http://daux.io">Daux.io</a></small></p>
                </div>
            </div>
        </div>
        <div class="right-column  content-area col-sm-9">
            <div class="content-page">
                <article>
            <div class="page-header sub-header clearfix">
            <h1><a href="../Module_Description/Ahrs_ekf.html">Module Description</a> <i class="glyphicon glyphicon-chevron-right"></i> <a href="../Module_Description/Ahrs_ekf.html">Ahrs ekf</a>            </h1>
                    <span style="float: left; font-size: 10px; color: gray;">
                        Tuesday, September 27, 2016                    </span>
                    <span style="float: right; font-size: 10px; color: gray;">
                        11:40 AM                    </span>
        </div>
    
    <h1>Module Description</h1>
<p>The Ahrs_ekf modules updates the ahrs structure using an extended kalman filter with updates from the accelerometer and magnetometer.</p>
<h3>Accelerometer Update Derivation</h3>
<p>We need to determine the measurement matrix (H) for the kalman filter. This is done by predicting what the measurement would be at any given attitude (h) and then obtaining the Jacobian matrix of that.</p>
<p>The state vector given in the Ahrs_ekf module is given as:</p>
<!-- \vec{x} = \begin{bmatrix} b_x \\ b_y \\ b_z \\ q_0 \\ q_1 \\ q_2 \\ q_3 \end{bmatrix} -->
<p><img src="http://mathurl.com/ze3ktfw.png" alt="State Vector" /></p>
<p>where b in the gyroscope biases and q is the ahrs quaternion.</p>
<p>The acceleration vector is the following:</p>
<!-- \vec{a} = \begin{bmatrix} 0 \\ 0 \\ g \end{bmatrix} -->
<p><img src="http://mathurl.com/zogc2o3.png" alt="Acceleration" /></p>
<p>g is positive as the positive z direction points towards the ground.</p>
<p>As we want to rotate the vector in the opposite direction of the ahrs quaternion, we can negate the i, j, and k component of the quaternion to get this rotation.</p>
<!-- \vec{q} = \begin{bmatrix} q_0 \\ -q_1 \\ -q_2 \\ -q_3  \end{bmatrix} -->
<p><img src="http://mathurl.com/gqbkhnz.png" alt="Acceleration" /></p>
<p>As per the quaternions_rotate_vector function in quaternions.h, we compute the following steps in order to rotate the vector.</p>
<!-- \vec{tmp}_1 = \begin{vmatrix} \vec{\imath} && \vec{\jmath} && \vec{k} \\ -q_1 && -q_2 && -q_3 \\ 0 && 0 && g \end{vmatrix} -->
<p><img src="http://mathurl.com/zgryhmu.png" alt="Acceleration" /></p>
<!-- \vec{tmp}_1 = \begin{bmatrix} -g q_2 \\ +g q_1 \\ 0 \end{bmatrix} -->
<p><img src="http://mathurl.com/j66o2gq.png" alt="Acceleration" /></p>
<!-- \vec{tmp}_1 = 2 \vec{tmp}_1 -->
<p><img src="http://mathurl.com/gnc6l5g.png" alt="Acceleration" /></p>
<!-- \vec{tmp}_1 = \begin{bmatrix} -2 g q_2 \\ +2 g q_1 \\ 0 \end{bmatrix} -->
<p><img src="http://mathurl.com/gnry9g7.png" alt="Acceleration" /></p>
<!-- \vec{tmp}_2 = \begin{vmatrix} \vec{\imath} && \vec{\jmath} && \vec{k} \\ -q_1 && -q_2 && -q_3 \\ -2 g q_2 && +2 g q_1 && 0 \end{vmatrix} -->
<p><img src="http://mathurl.com/jmmb5wk.png" alt="Acceleration" /></p>
<!-- \vec{tmp}_2 = \begin{bmatrix} 2 g q_1 q_3 \\ 2 g q_2 q_3 \\ -2 g q_1^2 - 2 g q_2^2 \end{bmatrix} -->
<p><img src="http://mathurl.com/zp36pbb.png" alt="Acceleration" /></p>
<!-- \vec{h} = \vec{a} + q_0 * \vec{tmp}_1 + \vec{tmp}_2 -->
<p><img src="http://mathurl.com/jca57ht.png" alt="Acceleration" /></p>
<p>Our final rotated vector is:</p>
<!-- \vec{h} = \begin{bmatrix} -2 g q_0 q_2 + 2 g q_1 q_3 \\ +2 g q_0 q_1 + 2 g q_2 q_3 \\ g - 2 g q_1^2 - 2 g q_2^2 \end{bmatrix} -->
<p><img src="http://mathurl.com/jygv2cz.png" alt="Acceleration" /></p>
<p>In order to obtain the measurement matrix in the kalman filter, we take the Jacobian of h with respect to the state vector.</p>
<!-- H = J_h(\vec{x}) = \begin{bmatrix} 0 && 0 && 0 && -2 g q_2 && +2 g q_3 && -2 g q_0 && +2 g q_1 \\ 0 && 0 && 0 && +2 g q_1 && +2 g q_0 && +2 g q_3 && +2 g q_2 \\ 0 && 0 && 0 && 0 && -4 g q_1 && -4 g q_2 && 0 \end{bmatrix} -->
<!-- For some reason, the website limits the matrix to 5 columns -->
<p><img src="./Images/Ahrs_ekf_acc_H.gif" alt="Acceleration" /></p>
<h3>Magnetometer Update Derivation</h3>
<p>We need to determine the measurement matrix (H) for the kalman filter. This is done by predicting what the measurement would be at any given attitude (h) and then obtaining the Jacobian matrix of that.</p>
<p>The state vector given in the Ahrs_ekf module is given as:</p>
<!-- \vec{x} = \begin{bmatrix} b_x \\ b_y \\ b_z \\ q_0 \\ q_1 \\ q_2 \\ q_3 \end{bmatrix} -->
<p><img src="http://mathurl.com/ze3ktfw.png" alt="State Vector" /></p>
<p>where b in the gyroscope biases and q is the ahrs quaternion.</p>
<p>The magnetometer vector is the following:</p>
<!-- \vec{m} = \begin{bmatrix} m_0 \\ m_1 \\ m_2 \end{bmatrix} -->
<p><img src="http://mathurl.com/jyosp6s.png" alt="Acceleration" /></p>
<p>As we want to rotate the vector in the opposite direction of the ahrs quaternion, we can negate the i, j, and k component of the quaternion to get this rotation.</p>
<!-- \vec{q} = \begin{bmatrix} q_0 \\ -q_1 \\ -q_2 \\ -q_3  \end{bmatrix} -->
<p><img src="http://mathurl.com/gqbkhnz.png" alt="Acceleration" /></p>
<p>As per the quaternions_rotate_vector function in quaternions.h, we compute the following steps in order to rotate the vector.</p>
<!-- \vec{tmp}_1 = \begin{vmatrix} \vec{\imath} && \vec{\jmath} && \vec{k} \\ -q_1 && -q_2 && -q_3 \\ m_0 && m_1 && m_2 \end{vmatrix} -->
<p><img src="http://mathurl.com/jckkqld.png" alt="Acceleration" /></p>
<!-- \vec{tmp}_1 = \begin{bmatrix} m_1 q_3 - m_2 q_2\\ -m_0 q_3 + m_2 q_1 \\ m_0 q_2 - m_1 q_1 \end{bmatrix} -->
<p><img src="http://mathurl.com/hzznupw.png" alt="Acceleration" /></p>
<!-- \vec{tmp}_1 = 2 \vec{tmp}_1 -->
<p><img src="http://mathurl.com/gnc6l5g.png" alt="Acceleration" /></p>
<!-- \vec{tmp}_1 = \vec{tmp}_1 = \begin{bmatrix} 2 m_1 q_3 - 2 m_2 q_2\\ -2 m_0 q_3 + 2 m_2 q_1 \\ 2 m_0 q_2 - 2 m_1 q_1 \end{bmatrix} -->
<p><img src="http://mathurl.com/zwjqzoq.png" alt="Acceleration" /></p>
<!-- \vec{tmp}_2 = \begin{vmatrix} \vec{\imath} && \vec{\jmath} && \vec{k} \\ -q_1 && -q_2 && -q_3 \\ 2 m_1 q_3 - 2 m_2 q_2 && -2 m_0 q_3 + 2 m_2 q_1 && 2 m_0 q_2 - 2 m_1 q_1 \end{vmatrix} -->
<p><img src="http://mathurl.com/jjqn6pd.png" alt="Acceleration" /></p>
<!-- \vec{tmp}_2 = \begin{bmatrix} -2 m_0 q_2^2 - 2 m_0 q_3^2 +2 m_1 q_1 q_2 + 2 m_2 q_1 q_3 \\ 2 m_0 q_1 q_2 - 2 m_1 q_1^2 - 2 m_1 q_3^2 + 2 m_2 q_2 q_3 \\ 2 m_0 q_1 q_3 + 2 m_1 q_2 q_3 - 2 m_2 q_1^2 - 2 m_2 q_2^2 \end{bmatrix} -->
<p><img src="http://mathurl.com/gpu8rvq.png" alt="Acceleration" /></p>
<!-- \vec{h} = \vec{a} + q_0 * \vec{tmp}_1 + \vec{tmp}_2 -->
<p><img src="http://mathurl.com/jca57ht.png" alt="Acceleration" /></p>
<p>Our final rotated vector is:</p>
<!-- \vec{h} = \begin{bmatrix} m_0 - 2 m_0 q_2^2 - 2 m_0 q_3^2 + 2 m_1 q_0 q_3 + 2 m_1 q_1 q_2 - 2 m_2 q_0 q_2 + 2 m_2 q_1 q_3 \\ m_1 - 2 m_0 q_0 q_3 + 2 m_0 q_1 q_2 - 2 m_1 q_1^2 -2 m_1 q_3^2 + 2 m_2 q_0 q_1 + 2 m_2 q_2 q_3 \\ m_2 + 2 m_0 q_0 q_2 + 2 m_0 q_1 q_3 - 2 m_1 q_0 q_1 + 2 m_1 q_2 q_3 - 2 m_2 q_1^2 - 2 m_2 q_2^2\end{bmatrix} -->
<p><img src="http://mathurl.com/jsnkmyz.png" alt="Acceleration" /></p>
<p>In order to obtain the measurement matrix in the kalman filter, we take the Jacobian of h with respect to the state vector.</p>
<!-- H = J_h(\vec{x}) = \begin{bmatrix} 0 && 0 && 0 && 2 m_1 q_3 - 2 m_2 q_2 && 2 m_1 q_2 + 2 m_2 q_3 && -4 m_0 q_2 + 2 m_1 q_1 - 2 m_2 q_0 && -4 m_0 q_3 + 2 m_1 q_0 + 2m_2 q_1 \\ 0 && 0 && 0 && -2 m_0 q_3 + 2 m_2 q_1 && 2 m_0 q_2 -4 m_1 q_1 +2 m_2 q_0 && 2 m_0 q_1 + 2 m_2 q_3 && -2 m_0 q_0 - 4 m_1 q_3 + 2 m_2 q_2 \\ 0 && 0 && 0 && 2 m_0 q_2 - 2 m_1 q_1 && 2 m_0 q_3 - 2 m_1 q_0 - 4 m_2 q_1 && 2 m_0 q_0 + 2 m_1 q_3 -4 m_2 q_2 && 2 m_0 q_1 + 2 m_1 q_2 \end{bmatrix} -->
<!-- For some reason, the website limits the matrix to 5 columns -->
<p><img src="./Images/Ahrs_ekf_mag_H.gif" alt="Acceleration" /></p>

        <nav>
        <ul class="pager">
            <li><a href="../Contributing/Development_Workflow.html">Previous</a></li>            <li><a href="../Pages_From_Wiki/Calibration-Bias-Factors.html">Next</a></li>        </ul>
    </nav>
    </article>

            </div>
        </div>
    </div>
</div>

    

    <!-- jQuery -->
    <script src="../themes/daux/js/jquery-1.11.3.min.js"></script>
    <!-- hightlight.js -->
    <script src="../themes/daux/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- JS -->
    
    <script src="../themes/daux/js/daux.js"></script>
</body>
</html>
